# .github/workflows/ci-suse.yml
name: CI (openSUSE)

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  suse:
    runs-on: ubuntu-latest
    container:
      image: registry.opensuse.org/opensuse/leap:15.6
    steps:
      - name: Install base tools (needed for checkout)
        run: |
          zypper -n refresh
          zypper -n install --no-recommends tar gzip xz git-core ca-certificates
      - uses: actions/checkout@v4

      - name: Install base tooling
        run: |
          set -euo pipefail
          zypper -n refresh
          zypper -n install --no-recommends \
            git-core bash ca-certificates curl \
            jq which tar gzip xz \
            python3 python3-pip
          # shellcheck (Namensunterschied je nach Repo)
          zypper -n install --no-recommends shellcheck || zypper -n install --no-recommends ShellCheck || true
          python3 -m pip install --no-cache-dir --upgrade pip || true
          python3 -m pip install --no-cache-dir pyyaml jsonschema intelhex || true

      - name: Mark repo as safe (if git exists)
        run: |
          if command -v git >/dev/null 2>&1; then
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
          fi

      - name: Run common checks
        run: |
          set -euo pipefail
          if [ -x scripts/ci_basic.sh ]; then
            bash scripts/ci_basic.sh || true
          else
            echo "scripts/ci_basic.sh not found or not executable, skipping"
          fi

      - name: Upload artifacts (if present)
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts-suse
          path: out
          if-no-files-found: ignore
