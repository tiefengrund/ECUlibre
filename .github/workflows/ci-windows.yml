name: CI (Windows)

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

permissions: { contents: read }

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install tools (Chocolatey + pip)
        shell: powershell
        run: |
          choco install -y shellcheck
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema intelhex

      - name: Run common checks
        shell: bash
        run: bash scripts/ci_basic.sh || true

      - name: Package Windows artifacts from HEX -> BIN (optional)
        shell: bash
        run: |
          set -euo pipefail
          if compgen -G "dist/deepseek/output/*.hex" > /dev/null; then
            if [ -f scripts/import_hex_to_bins.py ]; then
              python scripts/import_hex_to_bins.py
            else
              echo "import_hex_to_bins.py missing -> skip packaging"
            fi
          else
            echo "no HEX output -> skip packaging"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts-windows
          path: |
            out
            dist/windows/*.zip
            dist/windows/manifest-windows.csv
          if-no-files-found: ignore
